# Diagnosis Mapping
# Maps sub_state / status combinations to human-readable diagnoses and inline resolution steps

diagnoses:
  # CNR (Completed Not Received) states
  CNR_RESERVED_WAIT:
    icon: "‚è≥"
    short: "Waiting confirmation"
    meaning: |
      ‚úÖ Card payment via Checkout.com succeeded
      ‚úÖ Funds reserved for INR conversion
      ‚ùå LULU hasn't confirmed currency receipt
    root_cause: "Checkout payment succeeded but LULU fulfillment didn't get the webhook or failed to process CNR."
    confidence: 95
    steps:
      - title: "Verify Checkout Payment"
        time: "1 min"
        action: "Checkout Dashboard ‚Üí Search: {quote_id}"
        check: "Confirm: Payment status = CAPTURED"
      - title: "Check LULU Status"
        time: "2 min"
        action: "LULU Portal ‚Üí Search: {order_id}"
        check: "Order received? CNR status? Any errors?"
      - title: "Based on findings"
        conditions:
          - if: "Checkout ‚úÖ CAPTURED but LULU shows nothing"
            do: "Replay webhook: /ops replay-webhook {order_id}"
            alt: "Slack: @lulu-ops 'Order {order_id} missing, Checkout confirmed'"
          - if: "Checkout ‚úÖ and LULU shows order but stuck"
            do: "LULU Portal: Trigger manual CNR confirmation"
          - if: "Checkout shows FAILED"
            do: "Contact customer: Payment declined, retry needed"

  PAYMENT_FAILED:
    icon: "‚ùå"
    short: "Payment failed"
    meaning: |
      ‚ùå Card payment was declined or failed
      ‚ùå No funds captured
    root_cause: "Payment gateway declined the transaction. Check decline code for specific reason."
    confidence: 90
    steps:
      - title: "Check payment gateway logs"
        time: "1 min"
        action: "Payment Dashboard ‚Üí Search: {order_id}"
        check: "Find decline code and reason"
      - title: "Determine action"
        conditions:
          - if: "Insufficient funds / Card declined"
            do: "Contact customer: Ask to retry with different card"
          - if: "Fraud block"
            do: "Escalate to fraud team for review"
          - if: "Gateway timeout"
            do: "Retry payment processing via ops panel"

  BRN_PENDING:
    icon: "üîÑ"
    short: "BRN pending"
    meaning: |
      ‚úÖ Order created
      ‚è≥ BRN (Business Reference Number) not yet pushed to LULU
    root_cause: "System delay in pushing BRN to LULU exchange."
    confidence: 85
    steps:
      - title: "Check if BRN exists"
        time: "1 min"
        action: "Order details ‚Üí Check ftv_transaction_id"
        check: "If null, BRN not generated yet"
      - title: "Push BRN manually"
        time: "2 min"
        action: "/ops push-brn {order_id}"
        check: "Confirm LULU received the BRN"

  RFI_PENDING:
    icon: "üìã"
    short: "RFI pending"
    meaning: |
      ‚è≥ Request for Information sent to customer
      ‚è≥ Waiting for customer to submit documents
    root_cause: "Customer needs to provide additional KYC documents."
    confidence: 90
    steps:
      - title: "Check RFI status"
        time: "1 min"
        action: "KYC Portal ‚Üí Search: {user_id}"
        check: "What documents are pending?"
      - title: "Follow up if needed"
        conditions:
          - if: "RFI sent > 24h ago, no response"
            do: "Send reminder: /ops rfi-reminder {order_id}"
          - if: "RFI sent > 48h ago"
            do: "Call customer or escalate to KYC_ops"

  STATUS_SYNC_ISSUE:
    icon: "üîÑ"
    short: "Status sync issue"
    meaning: |
      ‚úÖ LULU shows CREDITED (money delivered)
      ‚ùå Our system still shows PROCESSING
    root_cause: "Webhook from LULU didn't update our status."
    confidence: 95
    steps:
      - title: "Verify LULU status"
        time: "1 min"
        action: "LULU Portal ‚Üí Search: {order_id}"
        check: "Confirm status = CREDITED or COMPLETED"
      - title: "Force status sync"
        time: "1 min"
        action: "/ops force-sync {order_id}"
        check: "Order should move to COMPLETED"

  DOCS_REQUIRED:
    icon: "üìÑ"
    short: "Docs required"
    meaning: |
      ‚è≥ Payout partner requires additional documents
      ‚ùå Order blocked until docs provided
    root_cause: "VDA/RDA partner flagged transaction for additional verification."
    confidence: 85
    steps:
      - title: "Check what docs needed"
        time: "1 min"
        action: "Payout Dashboard ‚Üí Search: {ftv_transaction_id}"
        check: "What documents are required?"
      - title: "Create RFI if not exists"
        conditions:
          - if: "No RFI created yet"
            do: "/ops create-rfi {order_id} --reason 'Partner docs required'"
          - if: "RFI exists, waiting"
            do: "Check KYC portal for customer response"

  DEFAULT:
    icon: "üîç"
    short: "Under review"
    meaning: |
      Order is in a non-standard state that requires investigation.
    root_cause: "Manual review needed to determine issue."
    confidence: 50
    steps:
      - title: "Check order timeline"
        time: "2 min"
        action: "Order history ‚Üí Review all status changes"
        check: "Where did the order get stuck?"
      - title: "Check all systems"
        time: "3 min"
        action: "Payment, LULU, Payout dashboards"
        check: "Cross-reference statuses"

# SLA configuration by stuck type
sla_config:
  PAYMENT_FAILED: 2    # 2 hours
  CNR_RESERVED_WAIT: 4 # 4 hours
  BRN_PENDING: 4       # 4 hours
  RFI_PENDING: 24      # 24 hours (waiting on customer)
  STATUS_SYNC_ISSUE: 1 # 1 hour (quick fix)
  DOCS_REQUIRED: 24    # 24 hours
  DEFAULT: 8           # 8 hours

# Escalation commands
escalation:
  command: "stuck {order_id} \"{reason}\""
  notifies:
    - "@dinesh"
    - "@tech-ops"
  creates: "incident"

# Resolution commands
resolution:
  command: "resolve {order_id} \"{notes}\""
  logs_to: "Google Sheet (ECM Resolution Log)"
  captures:
    - resolution_notes
    - agent
    - resolution_time
    - sla_status
