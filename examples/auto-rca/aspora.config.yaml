# Auto-RCA Domain Configuration
# This shows how skills are orchestrated WITHOUT writing Python code

domain:
  name: auto-rca
  description: "Automated root cause analysis for production incidents"
  owner: devops-team

skills:
  # Manager Skill (receives alerts, triages, routes)
  - name: auto-rca-detect-anomaly
    path: ./manager-detect-anomaly.md
    role: manager
    model: anthropic/claude-haiku-4.5
    cost_budget: $0.05
    triggers:
      - type: alert
        source: prometheus
        filter: "labels.severity in ['critical', 'warning']"

  # Specialist Skill (deep dive RCA)
  - name: auto-rca-trace-deployment
    path: ./specialist-trace-deployment.md
    role: specialist
    model: anthropic/claude-sonnet-4.5
    cost_budget: $0.15
    triggers:
      - type: routed
        from: auto-rca-detect-anomaly

# Routing Rules (Config-Driven, NOT Code)
routing:
  - when:
      skill: auto-rca-detect-anomaly
      output_match:
        anomaly_type: metric_spike
        recent_deployment: true
    then:
      route_to: auto-rca-trace-deployment
      pass_context:
        - metric
        - baseline
        - current
        - spike_time
        - deployment_time
        - deployment_id
        - service

  - when:
      skill: auto-rca-detect-anomaly
      output_match:
        anomaly_type: metric_spike
        recent_deployment: false
    then:
      route_to: auto-rca-general-investigation  # Different specialist if no deployment
      pass_context:
        - metric
        - spike_time
        - service

# Guardrails (Enforced at Runtime)
guardrails:
  budget:
    max_cost_per_alert: $0.50  # Manager + Specialist combined
    alert_if_exceeded: devops-team-slack

  human_in_loop:
    required_for:
      - action: rollback_deployment
        approver_role: senior-sre
      - action: modify_production_config
        approver_role: senior-sre

  rate_limits:
    max_executions_per_minute: 10  # Prevent alert storm overload

# Observability
observability:
  metrics:
    - name: auto_rca_executions_total
      type: counter
      labels: [skill, domain, outcome]

    - name: auto_rca_detection_latency_seconds
      type: histogram
      labels: [skill]

    - name: auto_rca_cost_dollars
      type: counter
      labels: [skill, model]

  logs:
    destination: langfuse
    capture:
      - skill_input
      - skill_output
      - reasoning_trace  # For ReAct debugging
      - user_corrections

  traces:
    destination: opik
    capture:
      - manager_to_specialist_handoff
      - tool_calls  # MCP tool usage
      - latency_breakdown

# Feedback Loop (Corrections → Tests)
feedback:
  capture_corrections: true
  auto_generate_tests: true
  test_framework: deepeval

  learning_strategy:
    type: reflexion  # User correction → reflection → updated approach
    storage: episodic_memory  # Store in pgvector

  regression_tests:
    generate_on_correction: true
    framework: promptfoo
    save_to: ./tests/generated/

# MCP Tools Available to Skills
mcp_tools:
  - server: prometheus-mcp
    tools:
      - query_prometheus
      - get_baseline

  - server: k8s-mcp
    tools:
      - query_deployments
      - get_deployment_diff
      - get_config_changes

  - server: logs-mcp
    tools:
      - query_logs
      - search_runbooks

  - server: memory-mcp
    tools:
      - get_similar_incidents  # Vector search in pgvector
